<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Jacques van Helden" />

<meta name="date" content="2020-04-08" />

<title>Practical – Supervised classification – Microarrays</title>

<script src="DenBoer_2009_supervised-classification_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="DenBoer_2009_supervised-classification_files/bootstrap-3.3.5/css/cerulean.min.css" rel="stylesheet" />
<script src="DenBoer_2009_supervised-classification_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="DenBoer_2009_supervised-classification_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="DenBoer_2009_supervised-classification_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="DenBoer_2009_supervised-classification_files/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="DenBoer_2009_supervised-classification_files/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="DenBoer_2009_supervised-classification_files/tocify-1.9.1/jquery.tocify.js"></script>
<script src="DenBoer_2009_supervised-classification_files/navigation-1.1/tabsets.js"></script>
<script src="DenBoer_2009_supervised-classification_files/navigation-1.1/codefolding.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  { color: #cccccc; background-color: #303030; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ffcfaf; } /* Alert */
code span.an { color: #7f9f7f; font-weight: bold; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #dca3a3; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #f0dfaf; } /* ControlFlow */
code span.ch { color: #dca3a3; } /* Char */
code span.cn { color: #dca3a3; font-weight: bold; } /* Constant */
code span.co { color: #7f9f7f; } /* Comment */
code span.cv { color: #7f9f7f; font-weight: bold; } /* CommentVar */
code span.do { color: #7f9f7f; } /* Documentation */
code span.dt { color: #dfdfbf; } /* DataType */
code span.dv { color: #dcdccc; } /* DecVal */
code span.er { color: #c3bf9f; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #c0bed1; } /* Float */
code span.fu { color: #efef8f; } /* Function */
code span.im { } /* Import */
code span.in { color: #7f9f7f; font-weight: bold; } /* Information */
code span.kw { color: #f0dfaf; } /* Keyword */
code span.op { color: #f0efd0; } /* Operator */
code span.ot { color: #efef8f; } /* Other */
code span.pp { color: #ffcfaf; font-weight: bold; } /* Preprocessor */
code span.sc { color: #dca3a3; } /* SpecialChar */
code span.ss { color: #cc9393; } /* SpecialString */
code span.st { color: #cc9393; } /* String */
code span.va { } /* Variable */
code span.vs { color: #cc9393; } /* VerbatimString */
code span.wa { color: #7f9f7f; font-weight: bold; } /* Warning */

.sourceCode .row {
  width: 100%;
}
.sourceCode {
  overflow-x: auto;
}
.code-folding-btn {
  margin-right: -30px;
}
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Practical – Supervised classification – Microarrays</h1>
<h3 class="subtitle">STAT2</h3>
<h4 class="author">Jacques van Helden</h4>
<h4 class="date">2020-04-08</h4>

</div>


<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">pkg &lt;-<span class="st"> &quot;e1071&quot;</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="cf">if</span> (<span class="op">!</span><span class="kw">require</span>(pkg, <span class="dt">character.only =</span> <span class="ot">TRUE</span>)) {</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">  <span class="kw">message</span>(<span class="st">&quot;Installing package &quot;</span>, pkg)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  <span class="kw">install.packages</span>(pkg, <span class="dt">dependencies =</span> <span class="ot">TRUE</span>, <span class="dt">quiet =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">  <span class="kw">require</span>(pkg)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">}</a></code></pre></div>
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>In this practical we will define a pipeline to run supervised classification on a multivariate dataset (transcriptome microarrays of leukemia from Den Boer 2009).</p>
</div>
<div id="study-case" class="section level2">
<h2>Study case</h2>
<p><strong>Reference:</strong> Den Boer ML <em>et al.</em> (2009). A subtype of childhood acute lymphoblastic leukaemia with poor treatment outcome: a genome-wide classification study. Lancet Oncol. 2009 10:125-34.</p>
<ul>
<li><strong>DOI</strong>: [<a href="http://doi.org/10.1016/S1470-2045(08)70339-5">doi: 10.1016/S1470-2045(08)70339-5</a>]</li>
<li><strong>Pubmed</strong>: [<a href="https://www.ncbi.nlm.nih.gov/pubmed/19138562">PMID 19138562</a>].</li>
<li><strong>Raw data</strong> available at Gene Expression Omnibus, series [<a href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE13425">GSE13425</a>]</li>
<li><strong>Preprocessed data</strong>: <a href="https://github.com/jvanheld/stat1/tree/master/data/DenBoer_2009" class="uri">https://github.com/jvanheld/stat1/tree/master/data/DenBoer_2009</a>.</li>
</ul>
</div>
<div id="data-pre-processing" class="section level2">
<h2>Data pre-processing</h2>
<p>The raw microarray data has been pre-processed in order to dispose of a ready-to-use dataset. pre-processing included</p>
<ul>
<li>filtering of barely detected or poorly expressed genes,</li>
<li>log2 transformation to normalise the raw measurements</li>
<li>between-sample standardisation to enable comparison between the different samples.</li>
</ul>
</div>
<div id="defining-the-local-folders-for-this-practical" class="section level2">
<h2>Defining the local folders for this practical</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co">####  Define Local directories and files ####</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="co">## Find the home directory</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">myHome &lt;-<span class="st"> </span><span class="kw">Sys.getenv</span>(<span class="st">&quot;HOME&quot;</span>)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="co">## Define the main directory for the  data and results</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">mainDir &lt;-<span class="st"> </span><span class="kw">file.path</span>(myHome,</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">                     <span class="st">&quot;STAT2_CMB_practicals&quot;</span>,</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">                     <span class="st">&quot;den-boer-2009&quot;</span>)</a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="kw">dir.create</span>(<span class="dt">path =</span> mainDir, </a>
<a class="sourceLine" id="cb2-11" data-line-number="11">           <span class="dt">recursive =</span> <span class="ot">TRUE</span>, </a>
<a class="sourceLine" id="cb2-12" data-line-number="12">           <span class="dt">showWarnings =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="kw">message</span>(<span class="st">&quot;Main dir: &quot;</span>, mainDir)</a>
<a class="sourceLine" id="cb2-14" data-line-number="14"></a>
<a class="sourceLine" id="cb2-15" data-line-number="15"><span class="co">## Define the dir where we will download the data</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16">destDir &lt;-<span class="st"> </span><span class="kw">file.path</span>(mainDir, <span class="st">&quot;data&quot;</span>)</a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="kw">dir.create</span>(<span class="dt">path =</span> destDir, </a>
<a class="sourceLine" id="cb2-18" data-line-number="18">           <span class="dt">recursive =</span> <span class="ot">TRUE</span>, </a>
<a class="sourceLine" id="cb2-19" data-line-number="19">           <span class="dt">showWarnings =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb2-20" data-line-number="20"><span class="kw">message</span>(<span class="st">&quot;Local data dir: &quot;</span>, destDir)</a>
<a class="sourceLine" id="cb2-21" data-line-number="21"></a>
<a class="sourceLine" id="cb2-22" data-line-number="22"><span class="co">## Define a file where we wills tore the memory image</span></a>
<a class="sourceLine" id="cb2-23" data-line-number="23">memImageFile &lt;-<span class="st"> </span><span class="kw">file.path</span>(mainDir, <span class="st">&quot;DenBoerData_loaded.Rdata&quot;</span>)</a>
<a class="sourceLine" id="cb2-24" data-line-number="24"><span class="kw">message</span>(<span class="st">&quot;Memory image file of the loaded data: &quot;</span>, memImageFile)</a></code></pre></div>
</div>
<div id="re-loading-the-pre-proocessed-data" class="section level2">
<h2>Re-loading the pre-proocessed data</h2>
<p>The detailed procedure to build the data set from tab-delimited files was described in the practical <a href="DenBoer_2009_load-and-explore_solutions.html"><strong>Data loading and exploration</strong></a>.</p>
<p>At the end of this practical we saved a memory image with the data. We provide hereby a few lines of code that should enable you to reload this data.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co">#### Load the data from a memory image ####</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">message</span>(<span class="st">&quot;Loading data from memory image file&quot;</span>)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">system.time</span>(<span class="kw">load</span>(memImageFile))</a></code></pre></div>
<pre><code>   user  system elapsed 
  0.559   0.028   0.588 </code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">message</span>(<span class="st">&quot;Data loaded&quot;</span>)</a></code></pre></div>
</div>
<div id="recommendations" class="section level2">
<h2>Recommendations</h2>
<ol start="0" style="list-style-type: decimal">
<li>Remember that we might need to run the same analyses</li>
</ol>
<ul>
<li>with different datasets</li>
<li>with different classifiers (to compare their performances)</li>
<li>with different parameter settings (to optimise a classifer)</li>
</ul>
<p>The code needs to be conceived with this in mind.</p>
<ol style="list-style-type: decimal">
<li><p>Split your code in modular sections. Whenever useful, write functions that can be called to run the different steps of an analysis.</p></li>
<li><p>The code should be re-usable by other people. For this, you need to document it.</p>
<ul>
<li>for developers who would reuse it and modify it (code documentation with hash comments)</li>
<li>for users (roxygen2 documentation for all the functions, tutorials, vignettes)</li>
</ul></li>
<li><p>Use the <code>message()</code> function (but not too many) to indicate when you start a task and finish a task + the main information (e.g. datadir, result dir, …).</p></li>
<li><p>Beware: traditionally, omics datasets (transcriptome, metabolome, proteome) are provided as matrices with 1 row per individual and 1 column per feature (variable),n but supervised classification methods expect martrices with individuals as rows and features as columns –&gt; you will need to transpose the matrix.</p></li>
</ol>
<div id="r-markdown-recommendations" class="section level3">
<h3>R markdown recommendations</h3>
<ol style="list-style-type: decimal">
<li>Name each chunk of code (you need to give a unique name)</li>
<li>In the chunk header, you can use different options to specify the figure size (e.g. <code>fig.width=7, fig.height=5</code>, and the relative width they will occupy on the output page (e.g. òut.width=“80%”)</li>
<li>When you interpret your data, do not hard-code the numerical results (e.g. performance metrics obtained at the end). Instead, you can insert dynamically their values in the text of the report with pieces of R code.</li>
</ol>
</div>
</div>
<div id="pipeline-for-the-final-report" class="section level2">
<h2>Pipeline for the final report</h2>
<ol style="list-style-type: decimal">
<li><p>Load the data (done above)</p></li>
<li><p>Exploring the data (done last time)</p>
<ul>
<li>histogram with the distribution of values</li>
<li>boxplots (if we have too many individuals, take subsets of them)</li>
<li>PC plots (PC1 vs PC2, PC3 vs PC4, …) with a coloring of the classes</li>
</ul></li>
<li><p>Normalisation (no need here, the data we loaded was previously pre-processed)</p></li>
<li><p>Class filtering: suppress the classes with less than 30 individuals, because it will be very difficult to train a program properly with so scsarse data.</p></li>
<li><p>Supervised classification, with 3 steps</p>
<ul>
<li><p>Split the data into training and testing subsets</p>
<ul>
<li>stratified subsampling: same proprotions of the 4 classes in the training as in the testing</li>
<li>iterative subsampling with 2/3 for training and 1/3 for testing.</li>
<li>run the subsampling 10 times independently</li>
</ul></li>
<li>Train a classifier with the training subset</li>
<li><p>Evaluate the performances of the trained classifier with the testing subset 4.4. Apply the classification to an independent dataset</p></li>
</ul></li>
<li><p>Reduction of dimensionality. Choose one among the following approaches</p>
<ul>
<li>Very simple (rudimentary) criterion: variable ordering by decreasing variance, and keep the <span class="math inline">\(n\)</span> top variables. Analyse the impact of <span class="math inline">\(n\)</span></li>
<li>PCA: keep the <span class="math inline">\(n\)</span> first components</li>
<li>Differential analysis: keep the <span class="math inline">\(n\)</span> most significant genes from differential analysis (I will provide you with the sorted list of genes)</li>
</ul></li>
<li><p>Evaluate the impact of parameters on the performances. Examples</p>
<ul>
<li>KNN: impact of K, the number of neighbours</li>
<li>SVM: impact of the kernel</li>
<li>Random Forest: impact of number of iterations, … other parameters</li>
<li>Discriminant analysis: impact of the homoscedasticity assumption (compare LDA with QDA).</li>
</ul></li>
<li><p>Compare the performances of 2 different classification methods (e.g. LDA, QDA, SVM, RF, KNN)</p></li>
<li><p>Interpret the results</p>
<ul>
<li><p>statistical performances</p></li>
<li><p>try to explain why some method or some parameter combination works better for your dataset that some other one, relationship with the data structure, the dimensionality of the feature space, …</p></li>
<li><p>biological relevance</p></li>
</ul></li>
</ol>
</div>
<div id="reporting" class="section level2">
<h2>Reporting</h2>
<ul>
<li><p>Each figure must be understandable by itself –&gt; documented by a legend, a title, labels on the axes, … Imagine that a reader starts by reading the figures before reading your interpretation text. The legends must be sufficient to understand the data that is displayed, but not include the interpretation of the figure.</p></li>
<li><p>Interpretation: for the readability, I would expect 1 - 2âragraphs at the end of each section, to interpret what can be seen in the figures / tables, results.</p></li>
<li><p>In particular, I expect your interpretation about the performance statistics. How trustable is a classifier with the observed rate of false positive, sensitivity, positive predictive value ? Can it be considered as valuable for diagnostics. Beyond the raw values of performance estimator, discuss about the distinct consequences of the different elements: for example the consequence of a false positive is not the same as a false negative.</p></li>
<li><p>The general discussion should provide the conclusion about the initial question (that you must formulate in the introduction).</p></li>
<li><p>The markdown should not specifically contain much detail about the code (it is meant as a scientific report) but you can (should) include one section with a general discussion about the organisation of your code. For example, in my case I will attempt to organise as much as possible of the code in re-usable functions, one function per basic operation (class filtering, data exploration, splitting between test and train, running the different classifiers, testing different parameters, integrating and comparing the results). I will write each funciton in a separate R file, and then the markdown will contain chunks that successively load the different functions, runs them and display the results. One possibility is to include <em>relative</em> links from the markdown to the individual functions, in order to facilitte their access to the reader.</p></li>
</ul>
</div>
<div id="hints" class="section level2">
<h2>Hints</h2>
<div id="relevant-packages-for-supervised-classification" class="section level3">
<h3>Relevant packages for supervised classification</h3>
<table>
<thead>
<tr class="header">
<th>Method</th>
<th>Package::Function(s)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Support vector machines (SVM)</td>
<td><code>e1071::svm()</code></td>
</tr>
<tr class="even">
<td>K nearest neighbours (KNN)</td>
<td><code>class::knn()</code></td>
</tr>
<tr class="odd">
<td>Random forest (RF)</td>
<td><code>randomForest::randomForest()</code></td>
</tr>
<tr class="even">
<td>Linear discriminant analysis</td>
<td><code>MASS::lda()</code></td>
</tr>
<tr class="odd">
<td>Utilities for supervised classification</td>
<td><code>caret</code> package</td>
</tr>
</tbody>
</table>
</div>
<div id="support" class="section level3">
<h3>Support</h3>
<ul>
<li>We interact via the Ametice forum for this job.</li>
<li>A support session by videoconference is scheduled on April 3, 10:00 - 12:00.</li>
</ul>
</div>
</div>
<div id="to-do" class="section level2">
<h2>To do</h2>
<ul>
<li><p>JvH: ask accounts for each student + a shared folder for this course, in order to give you access to the IFB-core RStudio server</p>
<p>done</p></li>
<li><p>JvH will add an independent dataset for evaluation, in the form of a Rdata memory image</p></li>
<li><p>JvH will give some hints, clues about some pieces of this work</p>
<ul>
<li><p>for each step indicate the relevant R functions (for example <code>sample()</code>, …)</p></li>
<li><p>for some step, provide an example of a properly documented function that does the job.</p></li>
</ul></li>
<li><p>Define some shared space for the code</p></li>
</ul>
</div>
<div id="solutions" class="section level2">
<h2>Solutions</h2>
<div id="data-loading" class="section level3">
<h3>Data loading</h3>
<p>This was treated in the tuto on Data loading and exploration.</p>
<p>Basically we have 3 tables</p>
<ul>
<li>expression data</li>
<li>metadata (“pheno”): table describing each biological sample / individual of the data</li>
<li>group descriptions</li>
</ul>
<p>The data has been saved as memory image that can be conveniently reloadded in less than 1 second.</p>
</div>
<div id="class-filtering" class="section level3">
<h3>Class filtering</h3>
<p>We filter out the class that contain less than 30 individuals.</p>
<p>The initial data contained 11 classes, after filtering we are left with 4 classes.</p>
<ul>
<li>T-ALL</li>
<li>TEL-AML1</li>
<li>hyperdiploid</li>
<li>pre-B ALL</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">kable</span>(<span class="kw">sort</span>(<span class="kw">table</span>(phenoTable<span class="op">$</span>Sample.title), <span class="dt">decreasing =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">      <span class="dt">caption =</span> <span class="st">&quot;Group sizes&quot;</span>)</a></code></pre></div>
<table>
<caption>Group sizes</caption>
<thead>
<tr class="header">
<th align="left">Var1</th>
<th align="right">Freq</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">hyperdiploid</td>
<td align="right">44</td>
</tr>
<tr class="even">
<td align="left">pre-B ALL</td>
<td align="right">44</td>
</tr>
<tr class="odd">
<td align="left">TEL-AML1</td>
<td align="right">43</td>
</tr>
<tr class="even">
<td align="left">T-ALL</td>
<td align="right">36</td>
</tr>
<tr class="odd">
<td align="left">E2A-rearranged (EP)</td>
<td align="right">8</td>
</tr>
<tr class="even">
<td align="left">BCR-ABL</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">E2A-rearranged (E-sub)</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="left">MLL</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">BCR-ABL + hyperdiploidy</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">E2A-rearranged (E)</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">TEL-AML1 + hyperdiploidy</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
<p>Alternative: do not apply the class filtering, but then refine the interpretation by discussing not only the general performance indicators, but also the capability to predict individual classes.</p>
<div id="my-trick" class="section level4">
<h4>My trick</h4>
<p>i define a function named <code>FilterClasses</code> that returns a list (conceptually an “object” even though I don’t implement it in object-oriented way) that gathers all the pieces of information together.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co">#&#39; @title Class filtering</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co">#&#39; @author Jacques van Helden</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co">#&#39; @description Given a data table and a vector of class memberships, discard the classes having less than a users-specified number of individuals.</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co">#&#39; @param x a data frame with one row per variable and one column per individual</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co">#&#39; @param classes a vector indicating the class of each individual</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co">#&#39; @param minPerClass=20 minimal number of inidividuals per class</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="co">#&#39; @return a list containing the filtered data table and vector of class memberships</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="co">#&#39; @export</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9">FilterClasses &lt;-<span class="st"> </span><span class="cf">function</span>(x,</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">                          classes,</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">                          <span class="dt">minPerClass=</span><span class="dv">20</span>) {</a>
<a class="sourceLine" id="cb7-12" data-line-number="12"></a>
<a class="sourceLine" id="cb7-13" data-line-number="13">  <span class="co">## Check that the data table and class vector have consistent dimensions</span></a>
<a class="sourceLine" id="cb7-14" data-line-number="14">  <span class="cf">if</span> (<span class="kw">length</span>(classes) <span class="op">!=</span><span class="st"> </span><span class="kw">ncol</span>(x)) {</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">    <span class="kw">stop</span>(<span class="st">&quot;The number of columns of x shoudl be identical to the length of classes&quot;</span>)</a>
<a class="sourceLine" id="cb7-16" data-line-number="16">  }</a>
<a class="sourceLine" id="cb7-17" data-line-number="17"></a>
<a class="sourceLine" id="cb7-18" data-line-number="18">  <span class="co">## Prepare a list that will hold the different pieces of result</span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19">  result &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb7-20" data-line-number="20">  result<span class="op">$</span>x &lt;-<span class="st"> </span><span class="kw">data.frame</span>() <span class="co">## will contain the subset of the data table restricted to the selected individuals</span></a>
<a class="sourceLine" id="cb7-21" data-line-number="21">  result<span class="op">$</span>classes &lt;-<span class="st"> </span><span class="kw">vector</span>() <span class="co">## will contain the class membership for the selected individuals</span></a>
<a class="sourceLine" id="cb7-22" data-line-number="22"></a>
<a class="sourceLine" id="cb7-23" data-line-number="23">  <span class="co">## Extract  class names</span></a>
<a class="sourceLine" id="cb7-24" data-line-number="24">  classNames &lt;-<span class="st"> </span><span class="kw">unique</span>(classes) <span class="co">## get a vector with unique values for class names</span></a>
<a class="sourceLine" id="cb7-25" data-line-number="25">  classSizes &lt;-<span class="st"> </span><span class="kw">table</span>(classes) <span class="co">## compute class sizes</span></a>
<a class="sourceLine" id="cb7-26" data-line-number="26">  <span class="co"># print(classsSizes)</span></a>
<a class="sourceLine" id="cb7-27" data-line-number="27"></a>
<a class="sourceLine" id="cb7-28" data-line-number="28">  <span class="co">## iterate over classes</span></a>
<a class="sourceLine" id="cb7-29" data-line-number="29">  <span class="cf">for</span> (class <span class="cf">in</span> classNames) {</a>
<a class="sourceLine" id="cb7-30" data-line-number="30"></a>
<a class="sourceLine" id="cb7-31" data-line-number="31">    <span class="co">## apply the threshold on class size</span></a>
<a class="sourceLine" id="cb7-32" data-line-number="32">    <span class="cf">if</span> (classSizes[class] <span class="op">&gt;=</span><span class="st"> </span>minPerClass) {</a>
<a class="sourceLine" id="cb7-33" data-line-number="33"></a>
<a class="sourceLine" id="cb7-34" data-line-number="34">      <span class="co">## Identify the individuals that belong to the current class</span></a>
<a class="sourceLine" id="cb7-35" data-line-number="35">      selected &lt;-<span class="st"> </span>(classes <span class="op">==</span><span class="st"> </span>class)</a>
<a class="sourceLine" id="cb7-36" data-line-number="36"></a>
<a class="sourceLine" id="cb7-37" data-line-number="37">      <span class="co">## A bit tricky: rbind will not work for the first class.</span></a>
<a class="sourceLine" id="cb7-38" data-line-number="38">      <span class="co">## create the data table with the first class, or append rows for subsequent classes.</span></a>
<a class="sourceLine" id="cb7-39" data-line-number="39">      <span class="cf">if</span> (<span class="kw">ncol</span>(result<span class="op">$</span>x) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb7-40" data-line-number="40">        result<span class="op">$</span>x &lt;-<span class="st"> </span><span class="kw">t</span>(x[, selected])</a>
<a class="sourceLine" id="cb7-41" data-line-number="41">      } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb7-42" data-line-number="42">        result<span class="op">$</span>x &lt;-<span class="st"> </span><span class="kw">rbind</span>(result<span class="op">$</span>x, <span class="kw">t</span>(x[, selected]))</a>
<a class="sourceLine" id="cb7-43" data-line-number="43">      }</a>
<a class="sourceLine" id="cb7-44" data-line-number="44"></a>
<a class="sourceLine" id="cb7-45" data-line-number="45">      <span class="co">## Append the class name for the individuals of the current class</span></a>
<a class="sourceLine" id="cb7-46" data-line-number="46">      result<span class="op">$</span>classes &lt;-<span class="st"> </span><span class="kw">append</span>(result<span class="op">$</span>classes, classes[selected])</a>
<a class="sourceLine" id="cb7-47" data-line-number="47">    }</a>
<a class="sourceLine" id="cb7-48" data-line-number="48">  }</a>
<a class="sourceLine" id="cb7-49" data-line-number="49"></a>
<a class="sourceLine" id="cb7-50" data-line-number="50">  <span class="co">## Build the result object (list) by adding fields with the relevant information</span></a>
<a class="sourceLine" id="cb7-51" data-line-number="51">  result<span class="op">$</span>nbClasses &lt;-<span class="st"> </span><span class="kw">length</span>(result<span class="op">$</span>classes) <span class="co">## Number of classes after filtering</span></a>
<a class="sourceLine" id="cb7-52" data-line-number="52">  result<span class="op">$</span>nbIndividuals &lt;-<span class="st"> </span><span class="kw">nrow</span>(result<span class="op">$</span>x) <span class="co">## Number of individuals</span></a>
<a class="sourceLine" id="cb7-53" data-line-number="53">  result<span class="op">$</span>nbVariables &lt;-<span class="st"> </span><span class="kw">ncol</span>(result<span class="op">$</span>x) <span class="co">## Number of variables</span></a>
<a class="sourceLine" id="cb7-54" data-line-number="54">  result<span class="op">$</span>classNames &lt;-<span class="st"> </span><span class="kw">unique</span>(result<span class="op">$</span>classes) <span class="co">## class names after filtering</span></a>
<a class="sourceLine" id="cb7-55" data-line-number="55">  result<span class="op">$</span>individualNames &lt;-<span class="st"> </span><span class="kw">rownames</span>(result<span class="op">$</span>x) <span class="co">## names of the remaining individuals after class filtering</span></a>
<a class="sourceLine" id="cb7-56" data-line-number="56">  result<span class="op">$</span>variableNames &lt;-<span class="st"> </span><span class="kw">colnames</span>(result<span class="op">$</span>x) <span class="co">## variable names</span></a>
<a class="sourceLine" id="cb7-57" data-line-number="57">  result<span class="op">$</span>classSizes &lt;-<span class="st"> </span><span class="kw">table</span>(result<span class="op">$</span>classes) <span class="co">## class sizes after filtering</span></a>
<a class="sourceLine" id="cb7-58" data-line-number="58">  <span class="kw">return</span>(result)</a>
<a class="sourceLine" id="cb7-59" data-line-number="59">}</a></code></pre></div>
<p>This function can then be used with user-specified parameters.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co">#### Filter out the classes having less than 30 individuals ####</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">filteredData &lt;-<span class="st"> </span><span class="kw">FilterClasses</span>(<span class="dt">x =</span> exprTable, </a>
<a class="sourceLine" id="cb8-3" data-line-number="3">                              <span class="dt">classes =</span> sampleGroup, </a>
<a class="sourceLine" id="cb8-4" data-line-number="4">                              <span class="dt">minPerClass =</span> <span class="dv">30</span>)</a>
<a class="sourceLine" id="cb8-5" data-line-number="5"></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="kw">kable</span>(<span class="kw">names</span>(filteredData), <span class="dt">col.names =</span> <span class="st">&quot;field&quot;</span>, </a>
<a class="sourceLine" id="cb8-7" data-line-number="7">      <span class="dt">caption =</span> <span class="st">&quot;fields of the filteredData list&quot;</span>)</a></code></pre></div>
<table>
<caption>fields of the filteredData list</caption>
<thead>
<tr class="header">
<th align="left">field</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">x</td>
</tr>
<tr class="even">
<td align="left">classes</td>
</tr>
<tr class="odd">
<td align="left">nbClasses</td>
</tr>
<tr class="even">
<td align="left">nbIndividuals</td>
</tr>
<tr class="odd">
<td align="left">nbVariables</td>
</tr>
<tr class="even">
<td align="left">classNames</td>
</tr>
<tr class="odd">
<td align="left">individualNames</td>
</tr>
<tr class="even">
<td align="left">variableNames</td>
</tr>
<tr class="odd">
<td align="left">classSizes</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co">## View(filteredData)</span></a></code></pre></div>
<p>The resulting list contains the following fields</p>
<ul>
<li><code>x</code> a data frame with the subset of individuals that belong to the selected classes (those having passed the class size threshold)</li>
<li><code>classes</code> a vector indicating the class membership for the selected individuals</li>
<li>additional variables indicating the numbers and the names of the individuals, the variables and the classes</li>
</ul>
<p>I will then progressively add fields to this list with the results of the different steps:</p>
<ul>
<li>the test/train splits</li>
<li>the results of the evaluations for each method and parameter value</li>
<li>the comparisons</li>
</ul>
<p>This means that a whole evaluation experiment comes together in a single variable (my list) and facilitates the consistency.</p>
</div>
</div>
<div id="splitting-of-the-data-set-in-testing-training-sets" class="section level3">
<h3>Splitting of the data set in testing / training sets</h3>
<p>Hint: the simplest way to do a random split is via the R function <code>sample()</code>. Two approaches:</p>
<ul>
<li>first sample the test set (for instance) and define the trainings set with <code>setdiff()</code>. Example:</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co">#### Iterative stratified subsampling ####</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="co">## Parameters</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4">iterations &lt;-<span class="st"> </span><span class="dv">10</span> <span class="co">## Number of train/test iterations</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">trainProba &lt;-<span class="st"> </span><span class="dv">2</span><span class="op">/</span><span class="dv">3</span> <span class="co">## Proportion of the dataset for the training set</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="co">## Message</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="kw">message</span>(<span class="st">&quot;Splitting data set into train (&quot;</span>, </a>
<a class="sourceLine" id="cb10-9" data-line-number="9">        <span class="kw">round</span>(trainProba, <span class="dt">digits =</span> <span class="dv">2</span>), <span class="st">&quot;)&quot;</span>, </a>
<a class="sourceLine" id="cb10-10" data-line-number="10">        <span class="st">&quot; and testing (&quot;</span>, </a>
<a class="sourceLine" id="cb10-11" data-line-number="11">        <span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">2</span>, <span class="dv">1</span> <span class="op">-</span><span class="st"> </span>trainProba), <span class="st">&quot;) sets for &quot;</span>,</a>
<a class="sourceLine" id="cb10-12" data-line-number="12">        iterations, <span class="st">&quot; iterations. &quot;</span>)</a>
<a class="sourceLine" id="cb10-13" data-line-number="13"></a>
<a class="sourceLine" id="cb10-14" data-line-number="14"><span class="co">## Create a table with one row per individual and one column per iteration</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15"><span class="co">## with Boolean values indicating whether the individual belongs to the </span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16"><span class="co">## train set (TRUE) or testing set (FALSE°)</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17">trainSets &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">matrix</span>(</a>
<a class="sourceLine" id="cb10-18" data-line-number="18">  <span class="dt">nrow =</span> filteredData<span class="op">$</span>nbIndividuals, </a>
<a class="sourceLine" id="cb10-19" data-line-number="19">  <span class="dt">ncol =</span> iterations, <span class="dt">data =</span> <span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb10-20" data-line-number="20"><span class="kw">rownames</span>(trainSets) &lt;-<span class="st"> </span>filteredData<span class="op">$</span>individualNames</a>
<a class="sourceLine" id="cb10-21" data-line-number="21"><span class="kw">colnames</span>(trainSets) &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span>iterations</a>
<a class="sourceLine" id="cb10-22" data-line-number="22"><span class="co"># dim(trainSets)</span></a>
<a class="sourceLine" id="cb10-23" data-line-number="23"><span class="co"># View(trainSets)</span></a>
<a class="sourceLine" id="cb10-24" data-line-number="24"></a>
<a class="sourceLine" id="cb10-25" data-line-number="25"><span class="co">## Select train / test sets for each iteration</span></a>
<a class="sourceLine" id="cb10-26" data-line-number="26"><span class="cf">for</span> (class <span class="cf">in</span> filteredData<span class="op">$</span>classNames) { <span class="co"># iterate over classes</span></a>
<a class="sourceLine" id="cb10-27" data-line-number="27">  <span class="co">## Select the indices of the class members</span></a>
<a class="sourceLine" id="cb10-28" data-line-number="28">  classMembers &lt;-<span class="st"> </span><span class="kw">which</span>(filteredData<span class="op">$</span>classes <span class="op">==</span><span class="st"> </span>class)</a>
<a class="sourceLine" id="cb10-29" data-line-number="29">  trainSetSize &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="kw">length</span>(classMembers) <span class="op">*</span><span class="st"> </span>trainProba)</a>
<a class="sourceLine" id="cb10-30" data-line-number="30">  <span class="cf">if</span> (trainSetSize <span class="op">&lt;</span><span class="st"> </span><span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb10-31" data-line-number="31">    <span class="kw">message</span>(<span class="st">&quot;</span><span class="ch">\t</span><span class="st">Warning: train set size is 0 for class &quot;</span>, class)</a>
<a class="sourceLine" id="cb10-32" data-line-number="32">  }</a>
<a class="sourceLine" id="cb10-33" data-line-number="33">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>iterations) { <span class="co"># iterations</span></a>
<a class="sourceLine" id="cb10-34" data-line-number="34">    trainIndices &lt;-<span class="st"> </span><span class="kw">sample</span>(classMembers, <span class="dt">replace =</span> <span class="ot">FALSE</span>, <span class="dt">size =</span> trainSetSize)</a>
<a class="sourceLine" id="cb10-35" data-line-number="35">    trainSets[trainIndices, i] &lt;-<span class="st"> </span><span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb10-36" data-line-number="36">  }</a>
<a class="sourceLine" id="cb10-37" data-line-number="37">}</a>
<a class="sourceLine" id="cb10-38" data-line-number="38"><span class="co"># View(trainSets)</span></a>
<a class="sourceLine" id="cb10-39" data-line-number="39"><span class="co"># apply(trainSets, 2, sum) ## training set sizes per iteration</span></a>
<a class="sourceLine" id="cb10-40" data-line-number="40"><span class="co"># apply(!trainSets, 2, sum) ## testing set sizes per iteration</span></a>
<a class="sourceLine" id="cb10-41" data-line-number="41">filteredData<span class="op">$</span>trainTable &lt;-<span class="st"> </span>trainSets</a>
<a class="sourceLine" id="cb10-42" data-line-number="42"><span class="co">## Alternative: use the probs option of sample()</span></a></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co">#### Check group balance between training and testing sets ####</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">i &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"></a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="kw">ceiling</span>(iterations<span class="op">/</span><span class="dv">3</span>), <span class="dv">3</span>))</a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">7</span>,<span class="dv">1</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>iterations) {</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">  <span class="kw">barplot</span>(<span class="kw">table</span>(filteredData<span class="op">$</span>trainTable[, i], filteredData<span class="op">$</span>classes), <span class="dt">horiz =</span> <span class="ot">TRUE</span>, <span class="dt">las =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb11-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb11-9" data-line-number="9"></a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="kw">par</span>(par.ori)</a></code></pre></div>
<p><img src="figures/02_combinatorix_check_train_test_balance-1.png" width="100%" style="display: block; margin: auto;" /></p>
<p><strong>Important</strong></p>
<ul>
<li>You need to sample the different classes separately to ensure a stratified subsampling</li>
<li>Make sure to run a sampling without replacement (replace=FALSE)</li>
<li>It is better to run the train/test split once in the beginning (with all the iterations) and store the train/test status of each sample at each iteration in a table, because this will enable you to use exaclty the same splits for each method you have to compare.</li>
</ul>
</div>
<div id="alternative-approaches" class="section level3">
<h3>Alternative approaches</h3>
<ul>
<li><p>I sugested an iterative subsampling: 10 times select a random subset as test and the rest as training sets. It is important to run it iteratively because each sample must be used sometimes for testing and sometimes for training. At each iteration, you can compute a confusion table (with 1/3 of the data) and then you compute the average of all the confusion tables.</p></li>
<li><p>An alternative is k-fold cross-validation. Split the data in K parts (for example 5-times CV –&gt; typically 32 samples for training and 8 samples for testing). In this case you iterate over the K subsets, each one becomes in turn a testing set, the other ones are sued for training. You collect the predicted class for each testing subset, and at the end you build a single confusion table with all the samples. This procedure guarantees that each sample is found one time in the test, adn K-1 times in a training set.</p></li>
<li><p>Some methods (but not all) are equipped with a CV (cross-validation) option, which does a particular modality of cross-vlaidation: the leave-one-one (LOO). This can be considered as an extreme form of the K-fold CV, where <span class="math inline">\(K = m\)</span> (number of samples). Since you need to compare methods, you will anyway need to implement your own train/test splitting function for the methods that do not support LOO, so the simplest is to use it all the time.</p></li>
</ul>
<p>If you want (for the sake of curiosity) you could also do some rapid test of the performance of a classifier with LOO.</p>
<p>In any case, the splitting sqhould be <strong>stratified</strong>, i.e. the different classes must be balanced between the testing and training sets.</p>
<p>Note: the <code>claret</code> package contains a lot of functions to run and evaluate supervised classification methods. It includes several functions to split a dataset into testing / training: <code>createDataPartition()</code>, <code>createFolds</code>, <code>createMultiFolds</code> , <code>createResample</code>.</p>
<p>The principle of the course is to teach you the principles. You are allowed to use <code>caret</code> but in this case you must be sure to understand exaclty what the functions you use are doing, and to configure their parameters properly. In particular, make sure that your splitting is stratified (balanced between the different classes).</p>
</div>
</div>
<div id="training-the-classifier" class="section level2">
<h2>Training the classifier</h2>
<p>Two possible approaches</p>
<ul>
<li>use the native methods (e.g. <code>lda()</code>, <code>knn()</code>, <code>svm()</code>, <code>randomForest()</code>)</li>
<li>use <code>caret::train()</code> which is a wrapper around these native functions.</li>
</ul>
<p>In the latter case, you must make sure that you understand how train() works, what idt does, what are its parameters, how to pass parameters from train to the native functions (for example, how do you use train() to pass the kernel to the svm() function ?). Actually <code>train()</code> passes all the parameter it does not know to the native function (e.g. <code>k</code>to <code>knn()</code>, or <code>kernel</code>to <code>svm()</code>).</p>
<p>Note: I just show here the principle of the analysis with one particular training/test split. Since the results will vary depending on the particular subsets used for testing ant training, the experiment should be repeated a given number of times (e.g. 10 iterations) and the performance statistics averaged over the different repetitions.</p>
<p>It will also be interesting to analyse the variation of the performances across the repetitions of the test.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co">#### Training an SVM classifier ####</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="co"># Note: here we arbitrarily set the iteration index to 1, but in the final work this should be iterated at least 10 times</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4">i &lt;-<span class="st"> </span><span class="dv">1</span> </a>
<a class="sourceLine" id="cb12-5" data-line-number="5"></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="co">## Select the training set</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7">trainingIndices &lt;-<span class="st"> </span>filteredData<span class="op">$</span>trainTable[, i]</a>
<a class="sourceLine" id="cb12-8" data-line-number="8">trainingSet &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(filteredData<span class="op">$</span>x[trainingIndices,])</a>
<a class="sourceLine" id="cb12-9" data-line-number="9">trainingLabels &lt;-<span class="st"> </span><span class="kw">as.factor</span>(filteredData<span class="op">$</span>classes[trainingIndices])</a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="co"># table(trainingLabels) # check the balance between classes in the training set</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"></a>
<a class="sourceLine" id="cb12-12" data-line-number="12"><span class="co">## Train the SVM classifier</span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13">svmKernel &lt;-<span class="st"> &quot;linear&quot;</span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14">svmTrained &lt;-<span class="st"> </span><span class="kw">svm</span>(<span class="dt">x =</span> trainingSet, </a>
<a class="sourceLine" id="cb12-15" data-line-number="15">                  <span class="dt">y =</span> trainingLabels,</a>
<a class="sourceLine" id="cb12-16" data-line-number="16">                  <span class="dt">kernel =</span> svmKernel)</a></code></pre></div>
</div>
<div id="testing" class="section level2">
<h2>Testing</h2>
<p>Hint: <code>stat::predict()</code></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co">## Select the training set</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">testingIndices &lt;-<span class="st"> </span><span class="op">!</span>filteredData<span class="op">$</span>trainTable[, i]</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">testingSet &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(filteredData<span class="op">$</span>x[testingIndices,])</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">testingLabels &lt;-<span class="st"> </span><span class="kw">as.factor</span>(filteredData<span class="op">$</span>classes[testingIndices])</a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="co"># dim(testingSet)</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="co"># table(testingLabels) # check the balance between classes in the training set</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"></a>
<a class="sourceLine" id="cb13-8" data-line-number="8">svmPrediction &lt;-<span class="st"> </span><span class="kw">predict</span>(svmTrained, testingSet)</a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="co"># View(svmPrediction)</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"><span class="co"># attributes(svmPrediction)</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11"></a>
<a class="sourceLine" id="cb13-12" data-line-number="12"><span class="co"># class(svmPrediction)</span></a>
<a class="sourceLine" id="cb13-13" data-line-number="13"><span class="co"># length(svmPrediction)</span></a></code></pre></div>
</div>
<div id="confusion-table" class="section level2">
<h2>Confusion table</h2>
<p>Manually: use the function <code>table()</code> to compare the annotated classes with the predicted ones.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co">#### Confusion table ####</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="co">## Compute confusion table</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4">confusionTable &lt;-<span class="st"> </span><span class="kw">table</span>(svmPrediction, testingLabels)</a>
<a class="sourceLine" id="cb14-5" data-line-number="5"></a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="co">## Print confusion table</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="kw">kable</span>(confusionTable, <span class="dt">caption =</span> <span class="st">&quot;Confusion table for SVM prediction in the testing set. Columns indicate the known class, rows the predicted class. The diagonal corresponds to correct classification, ant the outer triangles to misclassification errors. &quot;</span>)</a></code></pre></div>
<table>
<caption>Confusion table for SVM prediction in the testing set. Columns indicate the known class, rows the predicted class. The diagonal corresponds to correct classification, ant the outer triangles to misclassification errors.</caption>
<thead>
<tr class="header">
<th></th>
<th align="right">hyperdiploid</th>
<th align="right">pre-B ALL</th>
<th align="right">T-ALL</th>
<th align="right">TEL-AML1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>hyperdiploid</td>
<td align="right">14</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td>pre-B ALL</td>
<td align="right">1</td>
<td align="right">15</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td>T-ALL</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">12</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td>TEL-AML1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">14</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw">heatmap</span>(confusionTable, <span class="dt">Rowv =</span> <span class="ot">NA</span>, <span class="dt">Colv =</span> <span class="ot">NA</span>, <span class="dt">scale =</span> <span class="st">&quot;none&quot;</span>, </a>
<a class="sourceLine" id="cb15-2" data-line-number="2">        <span class="dt">cexRow =</span> <span class="fl">0.9</span>, <span class="dt">cexCol =</span> <span class="fl">0.9</span>,</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">        <span class="dt">col =</span> <span class="kw">gray</span>(<span class="dt">level =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">1</span>, <span class="dt">to =</span> <span class="dv">0</span>, <span class="dt">length.out =</span> <span class="dv">100</span>)))</a></code></pre></div>
<p><img src="figures/02_combinatorix_confusion_table_heatmap-1.png" width="50%" style="display: block; margin: auto;" /></p>
</div>
<div id="evaluation-of-the-performances" class="section level2">
<h2>Evaluation of the performances</h2>
<div id="global-performances-misclassification-error-rate-mer-and-accuracy" class="section level3">
<h3>Global performances: misclassification error rate (MER) and accuracy</h3>
<p>This is a multi-group classification. The primary statistics is thus the Misclassification Error Rate (MER).</p>
<p>If we run iterative subsampling, we should display the distribution of MER values obtained across the iterations (box plot).</p>
<p>An (optional) refinement could be to compute for each class the Sn and the FPR, and to display this on an XY plot (Y is Sn, and X is the FPR), and to display a different color / letter for each class.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="co">#### Compute hit rate and misclassification error rate ####</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"></a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="co">## First approach : compute the sum of diagonal of the confusion matrix</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4">svmHits &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="kw">diag</span>(<span class="dt">x =</span> confusionTable))</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">svmErrors &lt;-<span class="st"> </span><span class="kw">sum</span>(confusionTable) <span class="op">-</span><span class="st"> </span>svmHits</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">MER &lt;-<span class="st"> </span>svmErrors <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(confusionTable) <span class="op">*</span><span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"></a>
<a class="sourceLine" id="cb16-8" data-line-number="8"><span class="co">## Second approach (simpler): compare the training and predicted classes</span></a>
<a class="sourceLine" id="cb16-9" data-line-number="9">svmHits =<span class="st"> </span><span class="kw">sum</span>(svmPrediction <span class="op">==</span><span class="st"> </span>testingLabels)</a>
<a class="sourceLine" id="cb16-10" data-line-number="10">svmErrors =<span class="st"> </span><span class="kw">sum</span>(svmPrediction <span class="op">!=</span><span class="st"> </span>testingLabels)</a>
<a class="sourceLine" id="cb16-11" data-line-number="11">svmMER &lt;-<span class="st"> </span>svmErrors <span class="op">/</span><span class="st"> </span>(svmErrors <span class="op">+</span><span class="st"> </span>svmHits)</a>
<a class="sourceLine" id="cb16-12" data-line-number="12">svmAcc &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>svmMER</a></code></pre></div>
</div>
</div>
<div id="group-wise-statistics" class="section level2">
<h2>Group-wise statistics</h2>
<div id="comparison-between-results" class="section level3">
<h3>Comparison between results</h3>
<p>Comparison between results obtained with:</p>
<ul>
<li>the smae classifier and different parameters</li>
<li>different classifiers (assuming that you first selected the best parameters for each one)</li>
</ul>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
