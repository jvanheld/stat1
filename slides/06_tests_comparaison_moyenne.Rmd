---
title: "Tests de comparaison de moyenne"
author: "Jacques van Helden"
date: '`r Sys.Date()`'
output:
  slidy_presentation:
    fig_caption: yes
    fig_height: 6
    fig_width: 7
    highlight: tango
    incremental: no
    keep_md: yes
    smaller: yes
    theme: cerulean
    toc: yes
    widescreen: yes
  html_document:
    fig_caption: yes
    highlight: zenburn
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
  ioslides_presentation:
    css: slides.css
    fig_caption: yes
    fig_height: 6
    fig_width: 7
    highlight: tango
    smaller: yes
    toc: yes
    widescreen: yes
  pdf_document:
    fig_caption: yes
    highlight: zenburn
    toc: yes
    toc_depth: 3
  beamer_presentation:
    colortheme: dolphin
    fig_caption: yes
    fig_height: 6
    fig_width: 7
    fonttheme: structurebold
    highlight: tango
    incremental: no
    keep_tex: no
    slide_level: 2
    theme: Montpellier
    toc: yes
  word_document:
    toc: yes
    toc_depth: 3
font-import: http://fonts.googleapis.com/css?family=Risque
subtitle: Probabilités et statistique pour la biologie (STAT1)
font-family: Garamond
transition: linear
---

```{r include=FALSE, echo=FALSE, eval=TRUE}
library(knitr)
library(diagram) ## For flowcharts


options(width=300)
knitr::opts_chunk$set(
  fig.width = 7, fig.height = 5, 
  fig.align = "center", 
  fig.path = "figures/sampling-estimation_",
  size = "tiny", 
  echo = FALSE, eval=TRUE, 
  warning = FALSE, message = FALSE, 
  results = TRUE, comment = "")
# knitr::asis_output("\\footnotesize")

dir.main <- "~/stat1"
dir.slides <- file.path(dir.main, "slides")
setwd(dir.slides)
```


## Contenu

Nous présentons ici l'une des applications les plus populaires de la statistique: le test de comparaison de moyennes. 

Ce test est utilisé dans un grand nombre de contextes, nous l'appliquerons ici à deux types de données: 

1. Des **données artificielles** générées en tirant des échantillons au sein de deux populations qui suivent des distributions normales, et qui, selon le cas, présentent ou non une différence de moyenne. Le but sera de comprendre la mise en application du test et l'interprétation de ses résultats dans des conditions où nous contrôlons tous les paramètres (nous savons s'il existe ou non une différence entre les moyennes de populations). 

2. Des **données transcriptomiques** obtenues au moyen de biopuces. Nous testerons si un gène donné présente une différence d'expression entre deux groupes d'échantillons (par exemple des patients souffrant de deux types de cancers différents). 

    **Note:** la technologie des biopuces a largement été remplacée par le séquençage à haut débit, et le RNA-seq a rapidement été adopté pour les études transcriptomiques. Cependant l'analyse d'expression différentielle avec le RNA-seq requiert des concepts plus avancés, qui feront partie de cours ultérieurs. 


## L'hypothèse à tester

**Principe général:** 

- On observe une différence entre les moyennes d'échantillons, et on veut savoir si celle-ci résulte du hasard de l'échantillonnage ou d'une différence réelle entre les populations. 
- On pose l'***hypothèse nulle*** ($H_0$) selon laquelle il n'existe pas de différence entre les deux populations. L'***hypothèse alternative*** ($H_1$) est qu'il existe une différence. 
- On évalue la probabilité que les échantillons aient été générés selon cette hypothèse nulle. 
- Si cette probabilité est trop faible, on rejette l'hypothèse nulle ($RH_0$). 
- Sinon, on accepte (temporairement) l'hypothèse nulle ($AH_0$).



## Test bilatéral (*two-tailed test*)

$$H_0: \mu_1 = \mu_2 \\
H_1: \mu_1 \neq \mu_2$$

Il s'agit ici d'un **test bilatéral** (***two-tailed test***): nous désirons détecter une éventuelle différence indépendamment de son signe. 

## Test unilatéral (*one-tailed test*)

Modalité alternative: **test unilatéral** (***one-tailed test***), où l'on ne s'intéresse qu'à des différences allant dans une direction donnée. 


Différences positives (*right-tailed test*): 

$$H_0: \mu_1 \le \mu_2 \\
H_1: \mu_1 > \mu_2$$

Différences négatives (*left-tailed test*):

$$H_0: \mu_1 \ge \mu_2 \\
H_1: \mu_1 < \mu_2$$

## Hypothèses de travail

- Il existe différentes méthodes pour tester l'égalité entre deux moyennes. 

- Le choix de la méthode dépend de la nature des données. 

- Avant de réaliser le test il est crucial de se poser quelques questions afin de choisir la méthode appropriée. 

- Il s'agit de **vérifier les hypothèses de travail**, c'est-à-dire des hypothèses sur lesquelles reposera l'approche envisagée. 

## Hypothèse de normalité

**Les populations dont les échantillons sont tirés suivent-elles des distributions normales ?** 


- Si oui on peut réaliser des tests paramétriques (ils reposent sur une hypothèse de normalité). Dans le cas contraire il faut recourir à des tests non-paramétriques.

    **Pourquoi ?** Les tables de probabilités de risques des tests paramétriques ont été établies sur base de modèles mathématiques reposant sur l'hypothèse de normalité.

- En cas de non-normalité, **les échantillons sont-ils de grande taille ?** Si oui on peut se rabattre sur les méthodes paramétriques 

    **Pourquoi ?** En vertu du **théorème central limite**, les moyennes d'échantillon tendent vers une normale même si les populations-mères ne sont pas normales. 


## Hypothèse d'homoscédasticité (égalité des variances)

Pour les tests paramétriques, **les populations ont-elles (vraisemblablement) la même variance ? ** 


- Si oui on peut appliquer le test de Student. 

- Dans le cas contraire, test de Welch. 

    **Pourquoi ?** La distribution de probabilité de Student a été calculée sur base d'une hypothèse d'**homoscédasticité** (égalité des variances). Le test de Welch effectue une correction en cas d'**hétéroscédasticité** (inégalité des variances), en modifiant le nombre de degrés de liberté en fonction des différences entre variances. 

    
## Schéma du choix d'un test de comparaison de moyenne

```{r mean_compa_flowchart, fig.width=7, fig.height=6}
# creates an empty plot
openplotmat(main="Choice of a mean comparison test")

# create the coordinates
pos <- coordinates(c(1, 2, 2, 3))
pos[2,1] <- (pos[6,1] + pos[7, 1])/2
pos[4,1] <- (pos[6,1] + pos[7, 1])/2
pos[3,1] <- pos[8,1]
pos[5,1] <- pos[8,1]
pos.labels <- c("normality ?", 
               "Parametric", "Large samples ?", 
               "Equal var ?", "Non-parametric",
               "Student", "Welch", "Wilcoxon\nMann-Whitney")
nb.nodes <- nrow(pos)
question.nodes <- c(1, 3, 4)
  
fromto <- matrix(ncol = 2, byrow = TRUE,
                 data = c(1, 2, # 1
                          1, 3, # 2
                          3, 2, # 3
                          2, 4, # 4
                          4, 6, # 5
                          4, 7, # 6
                          3, 5, # 7
                          5, 8  # 8
                          ))
yes.arrows <- c(1,3,5)
no.arrows <- c(2,6,7)


nb.arrows     <- nrow(fromto)
arrpos <- matrix(ncol = 2, nrow = nb.arrows)
for (i in 1:nb.arrows) {
  if (i %in% yes.arrows) {
    arrow.color <- "#00BB00"
  } else if (i %in% no.arrows) {
    arrow.color <- "red"
  } else {
    arrow.color <- "black"
  }
 arrpos[i, ] <- straightarrow (
   from = pos[fromto[i, 1], ],
   to = pos[fromto[i, 2], ],
   lwd = 2, arr.pos = 0.5,
   arr.length = 0.25, lcol = arrow.color)
  if (i %in% yes.arrows) {
    text(arrpos[i, 1] + 0.02, arrpos[i, 2] - 0.03, "yes", col = "#00BB00")
  } else if (i %in% no.arrows) {
    text(arrpos[i, 1] + 0.02, arrpos[i, 2] - 0.03, "no", col = "red")
  }
}

for (i in 1:nb.nodes) {
  if (i %in% question.nodes) {
    ## Draw diamons for choices
    textdiamond(
      mid = pos[i,], radx = 0.2, rady = 0.05, 
      lab = pos.labels[i], cex = 1, 
      lcol="orange", lwd=2)
    
  } else {
    ## Draw ellipses for operations 
    textellipse(
      mid = pos[i,], radx=0.15, rady=0.05,
      lab=pos.labels[i])
  }
}
# text(arrpos[2, 1] + 0.05, arrpos[2, 2], "no", col = "red")
# text(arrpos[4, 1] - 0.05, arrpos[4, 2], "yes", col = "#00BB00")
# text(arrpos[5, 1] + 0.05, arrpos[5, 2], "no", col = "red")
# text(arrpos[4, 1] - 0.05, arrpos[4, 2], "yes", col = "#00BB00")
# text(arrpos[5, 1] + 0.05, arrpos[5, 2], "no", col = "red")


```


## Test de Student

Hypothèses d travail: **normalité** (ou bien grands échantillons), **homoscédasticité**. 

Statistique: 

$$t_{S} = \frac{\hat{\delta}}{\hat{\sigma}_\delta} =  \frac{\bar{x}_{2} - \bar{x}_{1}}{\sqrt{\frac{n_1 s_{1}^2 + n_2 s_{2}^2}{n_1+n_2-2} \left(\frac{1}{n_1}+ \frac{1}{n_2}\right)}}$$



| Sens du test   | Critère de décision |
|----------------------------|--------------------------------------|
| Bilatéral | $RH_0 \quad \text{if} \quad \lvert t_S \rvert > t_{1-\frac{\alpha}{2}}^{n_1 + n_2 -2}$ |
| Unilatéral à droite | $RH_0 \quad \text{if} \quad t_S > t_{1-\alpha}^{n_1 + n_2 -2}$ |
| Unilatéral à gauche | $RH_0 \quad \text{if} \quad t_S < t_{alpha}^{n_1 + n_2 -2} = - t_{1-\alpha}^{n_1 + n_2 -2}$ |
| | |

## Exercice

Un chercheur a analysé, à l’aide de biopuces, le niveau d’expression de l’ensemble des gènes à partir d’échantillons sanguins prélevés chez 50 patients (np=50) et chez 50 sujets témoins (nt=50). Il s’intéresse particulièrement à un gène qui semble montrer une différence entre les 2 groupes. Ainsi, il ré-analyse l’expression du même gène dans les mêmes échantillons en utilisant une autre technique, la qPCR. Il obtient 

-	pour les patients, une moyenne $m_p= 21$
-	pour les contrôles, une moyenne $m_t= 10$
-	des écarts-types identiques pour les 2 groupes $s_p= s_t= s = 15$

Afin de tester si la différence observée entre les moyennes est significative, le chercheur décide d’effectuer un test de Student.

a.	Le choix du test de Student vous semble-t-il approprié ? Justifiez le choix du chercheur. Quelles auraient été les alternatives envisageables ?

b.	Sachant qu’a priori on ne sait pas dans quel sens la maladie pourrait affecter le niveau d’expression du gène, préconisez-vous un test uni- ou bilatéral ?

c.	Formulez l’hypothèse nulle et expliquez-la en une phrase.

d.	Sur base de la formule ci-dessous, calculez la statistique $t$ de Student.

e.	Indiquez, en vous basant sur les tables fournies, la p-valeur correspondante. 

f.	Interprétez la p-valeur, et aidez le chercheur à tirer les conclusions de son étude.


## Exercice

Un groupe de chercheurs a détecté l’association, avec la résistance à la bilharziose, de taux élevés d’IgE spécifiques, une classe particulière d’anticorps. D’autres chercheurs ont cherché à répliquer ce résultat dans une population indépendante exposée à la bilharziose. Les résultats obtenus sont indiqués ci-dessous.

-	Pour les sujets résistants ($n_r=32$), la moyenne $m_r=10$.
-	Pour les sujets susceptibles ($n_s=32$), la moyenne $m_s=7$.
-	Les écarts-types des deux groupes sont égaux : $s_r = s_s = s = 2.8$.

a. Quelle méthode préconisez-vous pour tester l'égalité des moyennes (justifiez) ? Quelles sont les hypothèses de travail de ce test ?

b. En partant du principe que ces conditions sont remplies dans le cas présent, formulez l’hypothèse nulle et calculez le score t de Student (formule ci-dessous). Enfin, estimez P valeur à partir de la table fournie. 

c. A l'issue du test, quelle décision prenez-vous ? Justifiez votre réponse.







